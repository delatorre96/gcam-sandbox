MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
key_cols <- colnames(df)
key_cols <- key_cols[key_cols != 'scenario' & key_cols !=  'value' & key_cols !=  'Units']
df_ref <- df %>%
filter(scenario == "Reference") %>%
select(all_of(key_cols), value_ref = value)
df_chY <- df %>%
filter(scenario == "ChangeBaseYear") %>%
select(all_of(key_cols), value_chY = value)
df_comp <- df_ref %>%
inner_join(df_chY, by = key_cols)
df_metrics <- df_comp %>%
mutate(
error = value_ref - value_chY,
abs_error = abs(error),
sq_error = error^2
)
metrics_global <- df_metrics %>%
group_by(across(all_of(key_cols))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
key_cols2 <- key_cols[key_cols != 'year' & key_cols !=  'Units' ]
metrics_global <- df_metrics %>%
group_by(across(all_of(key_cols2))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
key_cols3 <- key_cols[key_cols != 'year' & key_cols !=  'Units'& key_cols !=  'region' ]
metrics_global_region <- df_metrics %>%
group_by(across(all_of(key_cols3))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
View(metrics_global_region)
metrics_global <- df_metrics %>%
group_by(region) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global <- df_metrics %>%
group_by(region, year) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global <- df_metrics %>%
group_by(sector) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global <- df_metrics %>%
group_by(subsector) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global <- df_metrics %>%
group_by(year) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global <- df_metrics %>%
group_by(region) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global <- df_metrics %>%
group_by(sector, year,region) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
criteriaMetrics <- c('sector', 'year','region')
for (i in criteriaMetrics){
metrics_global <- df_metrics %>%
group_by(i) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
}
criteriaMetrics <- c('sector', 'year','region')
for (i in 1:length(criteriaMetrics)){
metrics_global <- df_metrics %>%
group_by(criteriaMetrics[[i]]) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
}
criteriaMetrics[[i]]
metrics_global['query'] <- 'query'
metrics_global <- df_metrics %>%
group_by(sector) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
sector_metrics <- data.frame('query' = NULL,'sector' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
year_metrics <- data.frame('query' = NULL,'year' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
region_metrics <- data.frame('query' = NULL,'region' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
for (query in queries){
df <- getQuery(prj1,  query)
key_cols <- colnames(df)
key_cols <- key_cols[key_cols != 'scenario' & key_cols !=  'value']
df_ref <- df %>%
filter(scenario == "Reference") %>%
select(all_of(key_cols), value_ref = value)
df_chY <- df %>%
filter(scenario == "ChangeBaseYear") %>%
select(all_of(key_cols), value_chY = value)
df_comp <- df_ref %>%
inner_join(df_chY, by = key_cols)
df_metrics <- df_comp %>%
mutate(
error = value_ref - value_chY,
abs_error = abs(error),
sq_error = error^2
)
criteriaMetrics <- c('sector', 'year','region')
for (i in seq_along(criteriaMetrics)) {
crit <- criteriaMetrics[i]
metrics_global <- df_metrics %>%
group_by(across(all_of(crit))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE)
)
metrics_global['query'] <- query
if (crit == 'sector'){
sector_metrics <- bind_rows(sector_metrics, metrics_global)
} else if(crit == 'year'){
year_metrics <- bind_rows(year_metrics, metrics_global)
} else {
region_metrics <- bind_rows(region_metrics, metrics_global)
}
}
}
query
View(df)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units' &    ]
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units']
cols
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
print(cols)
}
variables <- c()
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
variables <- c(variables,cols)
}
variables <- unique(variables)
variables
variables <- c()
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
variables <- c(variables,cols)
}
variables
variables <- c()
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
variables <- c(variables,cols)
}
variables <- unique(variables)
variables
list_metrics_vars <- vector("list", length(variables))
names(list_metrics_vars) <- variables
list_metrics_vars
variables <- c()
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
variables <- c(variables,cols)
}
variables <- unique(variables)
list_metrics_vars <- vector("list", length(variables))
names(list_metrics_vars) <- variables
year_metrics <- data.frame('query' = NULL,'year' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
region_metrics <- data.frame('query' = NULL,'region' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
for (query in queries){
df <- getQuery(prj1,  query)
key_cols <- colnames(df)
key_cols <- key_cols[key_cols != 'scenario' & key_cols !=  'value']
df_ref <- df %>%
filter(scenario == "Reference") %>%
select(all_of(key_cols), value_ref = value)
df_chY <- df %>%
filter(scenario == "ChangeBaseYear") %>%
select(all_of(key_cols), value_chY = value)
df_comp <- df_ref %>%
inner_join(df_chY, by = key_cols)
df_metrics <- df_comp %>%
mutate(
error = value_ref - value_chY,
abs_error = abs(error),
sq_error = error^2
)
for (crit in c('year', 'region')) {
if (crit %in% colnames(df_metrics)) {
metrics_global <- df_metrics %>%
group_by(across(all_of(crit))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
if (crit == 'year') {
year_metrics <- bind_rows(year_metrics, metrics_global)
} else if (crit == 'region') {
region_metrics <- bind_rows(region_metrics, metrics_global)
}
}
}
for (var in variables) {
if (var %in% colnames(df_metrics)) {
metrics_global <- df_metrics %>%
group_by(across(all_of(var))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
# Agrega o concatena el resultado en la lista
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- metrics_global
} else {
list_metrics_vars[[var]] <- bind_rows(list_metrics_vars[[var]], metrics_global)
}
} else {
# Si no está la variable, se puede guardar NULL o un data frame vacío con query para rastrear
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- data.frame(query = query)[0,] # DF vacío con columna query para mantener estructura
}
}
}
}
list_metrics_vars[[var]]
list_metrics_vars
variables <- c()
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
variables <- c(variables,cols)
}
variables <- unique(variables)
list_metrics_vars <- vector("list", length(variables))
names(list_metrics_vars) <- variables
for (v in variables) {
list_metrics_vars[[v]] <- NULL
}
year_metrics <- data.frame('query' = NULL,'year' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
region_metrics <- data.frame('query' = NULL,'region' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
for (query in queries){
df <- getQuery(prj1,  query)
key_cols <- colnames(df)
key_cols <- key_cols[key_cols != 'scenario' & key_cols !=  'value']
df_ref <- df %>%
filter(scenario == "Reference") %>%
select(all_of(key_cols), value_ref = value)
df_chY <- df %>%
filter(scenario == "ChangeBaseYear") %>%
select(all_of(key_cols), value_chY = value)
df_comp <- df_ref %>%
inner_join(df_chY, by = key_cols)
df_metrics <- df_comp %>%
mutate(
error = value_ref - value_chY,
abs_error = abs(error),
sq_error = error^2
)
for (crit in c('year', 'region')) {
if (crit %in% colnames(df_metrics)) {
metrics_global <- df_metrics %>%
group_by(across(all_of(crit))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
if (crit == 'year') {
year_metrics <- bind_rows(year_metrics, metrics_global)
} else if (crit == 'region') {
region_metrics <- bind_rows(region_metrics, metrics_global)
}
}
}
for (var in variables) {
if (var %in% colnames(df_metrics)) {
metrics_global <- df_metrics %>%
group_by(across(all_of(var))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
# Agrega o concatena el resultado en la lista
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- metrics_global
} else {
list_metrics_vars[[var]] <- bind_rows(list_metrics_vars[[var]], metrics_global)
}
} else {
# Si no está la variable, se puede guardar NULL o un data frame vacío con query para rastrear
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- data.frame(query = query)[0,] # DF vacío con columna query para mantener estructura
}
}
}
}
list_metrics_vars
query
df
var %in% colnames(df_metrics)
var
metrics_global <- df_metrics %>%
group_by(across(all_of(var))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
metrics_global
# Agrega o concatena el resultado en la lista
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- metrics_global
} else {
list_metrics_vars[[var]] <- bind_rows(list_metrics_vars[[var]], metrics_global)
}
is.null(list_metrics_vars[[var]])
list_metrics_vars[[var]] <- bind_rows(list_metrics_vars[[var]], metrics_global)
list_metrics_vars[[var]]
var
list_metrics_vars
is.null(list_metrics_vars[[var]])
list_metrics_vars[[var]]
list_metrics_vars[[var]] == 0
variables <- c()
for (query in queries){
df <- getQuery(prj1,  query)
cols <- colnames(df)
cols <- cols[cols != 'scenario' &
cols !=  'value' &
cols != 'region' &
cols !=  'Units'&
cols !=  'year']
variables <- c(variables,cols)
}
variables <- unique(variables)
list_metrics_vars <- vector("list", length(variables))
names(list_metrics_vars) <- variables
empty_df <- data.frame(
MAE = numeric(),
MSE = numeric(),
RMSE = numeric(),
query = character()
)
for (v in variables) {
list_metrics_vars[[v]] <- empty_df[0, ]
}
list_metrics_vars
year_metrics <- data.frame('query' = NULL,'year' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
region_metrics <- data.frame('query' = NULL,'region' = NULL, 'MAE' = NULL, 'MSE' = NULL, 'RMSE' = NULL)
for (query in queries){
df <- getQuery(prj1,  query)
key_cols <- colnames(df)
key_cols <- key_cols[key_cols != 'scenario' & key_cols !=  'value']
df_ref <- df %>%
filter(scenario == "Reference") %>%
select(all_of(key_cols), value_ref = value)
df_chY <- df %>%
filter(scenario == "ChangeBaseYear") %>%
select(all_of(key_cols), value_chY = value)
df_comp <- df_ref %>%
inner_join(df_chY, by = key_cols)
df_metrics <- df_comp %>%
mutate(
error = value_ref - value_chY,
abs_error = abs(error),
sq_error = error^2
)
for (crit in c('year', 'region')) {
if (crit %in% colnames(df_metrics)) {
metrics_global <- df_metrics %>%
group_by(across(all_of(crit))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
if (crit == 'year') {
year_metrics <- bind_rows(year_metrics, metrics_global)
} else if (crit == 'region') {
region_metrics <- bind_rows(region_metrics, metrics_global)
}
}
}
for (var in variables) {
if (var %in% colnames(df_metrics)) {
metrics_global <- df_metrics %>%
group_by(across(all_of(var))) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
MSE = mean(sq_error, na.rm = TRUE),
RMSE = sqrt(MSE),
.groups = "drop"
)
metrics_global['query'] <- query
# Agrega o concatena el resultado en la lista
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- metrics_global
} else {
list_metrics_vars[[var]] <- bind_rows(list_metrics_vars[[var]], metrics_global)
}
} else {
# Si no está la variable, se puede guardar NULL o un data frame vacío con query para rastrear
if (is.null(list_metrics_vars[[var]])) {
list_metrics_vars[[var]] <- data.frame(query = query)[0,] # DF vacío con columna query para mantener estructura
}
}
}
}
list_metrics_vars
names(list_metrics_vars)
View(list_metrics_vars$sector)
View(year_metrics)
View(year_metrics)
saveRDS(year_metrics, "year_metrics.rds")
saveRDS(region_metrics, "region_metrics.rds")
saveRDS(list_metrics_vars, "list_metrics_vars.rds")
save(sector_metrics, year_metrics, region_metrics, list_metrics_vars, file = "all_metrics.RData")
load("all_metrics.RData")
load("all_metrics.RData")
